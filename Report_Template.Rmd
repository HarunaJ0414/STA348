---
title: "Hidden Markov Modeling of the Nikkei 225: An Empirical Comparison of Two- and Three-State Specifications"
author: "Haruna Jukurogi"
date: "`r Sys.Date()`" #  
output:
  pdf_document:
      number_sections: true
spacing: double
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[L]{Title of Project}
- \fancyfoot[CO,CE]{}
- \fancyfoot[LE,RO]{\thepage}
- \usepackage{setspace}\doublespacing
---

```{=tex}
\newpage 
\tableofcontents 
\newpage
```
```{r setup, setup, message=FALSE, warning=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Installing packages required for this project
install.packages("quantmod")
install.packages("ggplot2")
install.packages("dplyr")
install.packages("tidyr")
install.packages("depmixS4")

```

\newpage

# Introduction

In the finance world, there is a theory where you refer to the market conditions with the terms "Bull" and "Bear." The "Bull" market is when the market is on rise and sound, and the "Bear" market is receding and the most stocks are declining in values.

This project aims to analyze the Japanese market returns (Nikkei 225) by comparing the following 2 Hidden Markov Models to justify the inclusion of a third, intermediate regime: 2 state model with "Bull" and "Bear" states 3 state model with "Bull", "Normal", and "Bear"

Japanese market has had some interesting fluctuations since 1985. The following is some timeline.

```{r setup, message=FALSE, warning=FALSE, echo=FALSE}
library(readr)
market_events <- read_csv("Japanese Market Major Events (1985-2025).csv", show_col_types = FALSE)
knitr::kable(market_events)
```

Also Japan is known to have gone through 'The Lost Decades,' which refers to the nearly ten years of slow or negative growth in Japan from 1990.

The goal of this project is to see if the 3-state model fits the market more than the 2-state model.

The rest of this project is as follows. In Section 2, we review some basic concepts. In Section 3, we introduce the topic. In Section 4, we have an application and simulation. Section 5 provides conclusion and some closing remarks.

# Review of the Topic

The core methodology for this analysis relies on Hidden Markov Model (HMM), a statistical model used to describe the evolution of observable events that depend on internal factors that are not directly visible.

To understand HMMs, we mush first define the underlying Markov Chain. A Markov Chain is a stochastic process describing a sequence of events where the probability of moving to the next state only depends on the current state.

## Definitions and Examples

Markov Chain is governed by two key 1. components: Transition Probability $$
P\{y_{n+1}=j \mid y_n = i, y_{n-1}=i_{n-1}, \ldots, y_1 = i_1\}
= P\{y_{n+1}=j \mid y_n = i\} = t(i,j)
$$ where $y_i$ is an underlying state. $t(i,j)$ is the transition probability, which is the fixed probability for making a transition from one hidden state $i$ to another hidden state $j$.

Emission Probability $$
P\{x_{n}=x \mid y_n = i, y_{n-1}, x_{n-1} \ldots\}
= P\{x_{n}=x \mid y_n = i\} = e(x \mid i)
$$ where $x_i$ is an observation. $e(x|i)$ is the emission probability, which is the probability of the $n$th observation being $x_n=x$. This shows that the probability of $x_n = x$ depends only on the underlying state $y_n$. Hidden Markov Chain is a statistical model describes the progress of observable events with an underlying invisible factor. Those events fall into the invisible states, which follow the Markov Chain.

## Details of the topic

In this project, the observations are daily returns from Nikkei 255, and the underlying states (hidden states) are: 2-state model: {"Bull", "Bear"} 3-state model: {"Bull", "Normal", "Bear"}

I selected Nikkei 225 for this analysis because it serves as the premier benchmark for the Japanese stock market and is the most widely recognized indicator of market sentiment in Japan.

Using quantmod package, I downloaded the daily returns of Nikkei 225 from 01/01/1985 to 11/26/2025. The graph of the returns is as follows.

For cleaning processes, I removed the dates with no data and saved them as returns_clean.

```{r download, echo=FALSE, message=FALSE, warning=FALSE}
library(quantmod)

getSymbols("^N225", src = "yahoo", from="1985-01-01", to="2025-11-26")

returns <- dailyReturn(N225)

returns_clean <- na.omit(returns)

plot(returns, main="Nikkei 225 Daily Returns")
```

I compared the 2 models using the following criteria:

Akaike Information Criterion (AIC) $AIC = 2k - 2ln(\hat L)$ where $k$ = the number of model parameters $L$ = the maximum value of the likelihood function of the model

Bayesian Information Criterion (BIC) $kln(n)-2ln(\hat L)$ where $k$ = the number of parameters estimated by the model $n$ = the number of data points in $x$ $\hat L$ = the maximized value of the likelihood function of the model

# Application

I fit the dataset to the 2- and 3-state model using depmixS4 package.

```{r fitting, message=FALSE, warning=FALSE, echo=FALSE}
library(depmixS4)

# Hidden Markov Model, number of states
n1_states <- 2
n2_states <- 3

hmm_model2 <- depmix(returns_clean ~ 1, family = gaussian(), nstates = n1_states, 
                    data = data.frame(returns_clean))

hmm_model3 <- depmix(returns_clean ~ 1, family = gaussian(), nstates = n2_states, 
                    data = data.frame(returns_clean))

# Fitting model for 2 states
set.seed(2003)
fitted2 <- fit(hmm_model2)

# Fitting model for 3 states
fitted3 <- fit(hmm_model3)
```

First, I obtained the transition probabilities and emission parameters for the 2-state model as below.

```{r 2-state, message=FALSE, warning=FALSE, echo=FALSE}
# Get the transition matrix for 2 states
transition_probs2 <- getpars(fitted2)[3:6]
transition_probs2 <- matrix(transition_probs2, nrow = 2, byrow = TRUE)
colnames(transition_probs2) <- c("Bear", "Bull")
rownames(transition_probs2) <- c("Bear", "Bull")
print("Transition Probabilities for 2-States Model:")
print(transition_probs2)

# Get the emission parameters for 2 states
emission_params2 <- getpars(fitted2)[7:10]
emission_params2 <- matrix(emission_params2, nrow = 2, byrow = TRUE)
colnames(emission_params2) <- c("mean", "sd")
rownames(emission_params2) <- c("Bear", "Bull")
print("Emission Parameters for 2-State Model:")
print(emission_params2)

# Predict the hidden states for 2 states
predicted_states2 <- posterior(fitted2, type="viterbi")
```

It seems that the market tends to stay in the same state the next day rather than moving to the other state.

Here, the "Bull" market has a lower mean and a higher volatility as indicated in the emission parameters.

Then, I also obtained the transition probabilities and the emission parameters for the 3-state model.

```{r 3-state, message=FALSE, warning=FALSE, echo=FALSE}
# Get the transition matrix for 3 states
transition_probs3 <- getpars(fitted3)[4:12]
transition_probs3 <- matrix(transition_probs3, nrow = 3, byrow = TRUE)
colnames(transition_probs3) <- c("Bull", "Bear", "Normal")
rownames(transition_probs3) <- c("Bull", "Bear", "Normal")
print("Transition Probabilities for 3-States Model:")
print(transition_probs3)

# Get the emission parameters for 3 states
emission_params3 <- getpars(fitted3)[13:18]
emission_params3 <- matrix(emission_params3, nrow = 3, byrow = TRUE)
colnames(emission_params3) <- c("mean", "sd")
rownames(emission_params3) <- c("Bull", "Bear", "Normal")
print("Emission Parameters for 3-States Model:")
print(emission_params3)

# Predict the hidden states for 3 states
predicted_states3 <- posterior(fitted3, type="viterbi")
```

Notably, the transition probabilities from Bull to Bear ($1.22 \times 10^{-8}$) and Bear to Bull ($8.86 \times 10^{-15}$) are effectively zero. This indicates that the 'Normal' state acts as a necessary buffer or transition phase. The market rarely moves directly from a Bull market to a Bear market without passing through a transitional period first.

In addition to that, you can see that the mean of the "Bull" market is greater in the 3-state model than in the 2-state model, and the "Bear" market has a smaller mean than the 2-state model. This means it emphasizes the differences between the "Bull" market and the "Bear" market more in the 3-state model than in the 2-state model.

Also, you can see that the mean of the "Normal" state is approximately 0.

The following shows the model selection criteria for the 2- and 3-state models.

```{r model_selection, message=FALSE, warning=FALSE, echo=FALSE}
AIC2 <- AIC(fitted2)
BIC2 <- BIC(fitted2)

AIC3 <- AIC(fitted3)
BIC3 <- BIC(fitted3)

info_criteria <- data.frame(
  Model = c("2-state", "3-state"),
  AIC   = c(AIC2, AIC3),
  BIC   = c(BIC2, BIC3)
)

info_criteria
```

As shown in the table above, the 3-state model has lower AIC and BIC than the 2-state model, suggesting that the 3-state model is a better quality than the 2-state model.

You can also see how the market made transitions over time for each model.

The below is the plot for the 2-state model.

```{r plot2, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.show='hold'}
dates <- index(returns_clean)

# 2-state
plot(dates, predicted_states2$state,
     type = "s",
     xlab = "Date", ylab = "State",
     yaxt = "n",
     main = "2-State Model")
axis(2, at = 1:2, labels = c("Bear", "Bull"))
```

The following is the plot for the 3-state model.

```{r plot3, message=FALSE, warning=FALSE, echo=FALSE, fig.align='center', fig.show='hold'}
# 3-state
state_plot <- ifelse(predicted_states3 == 1, 1, 
                ifelse(predicted_states3 == 3, 2, 3))
plot(dates, predicted_states3$state,
     type = "s",
     xlab = "Date", ylab = "State",
     yaxt = "n",
     main = "3-State Model")
axis(2, at = 1:3, labels = c("Bull", "Normal", "Bear"))
```

You can see that the bull market dominates between 1985 to 1990, which coincides with the Bubble Era.

Also approximately in 1997, 2008, and 2011, which are Asian Financial Crisis, Global Financial Crisis, and Great East Japan Earthquake, respectively, the "Bear" state dominates.

More recently, after 2020, the market is in the "Bear" state, reflecting the impact of the COVID-19 pandemic.

When you focus on the "Normal" state, you can see that the Normal state becomes prevalent after 1991 when the Bubble burst to early 2000s, suggesting this is the "Lost Decades".

# Conclusion

From this analysis, the 2-state model captures the basic dynamics of the Japanese stock market by distinguishing between "Bull" (positive and low volatility) and "Bear" (negative and high volatility) regimes. However, by introducing the intermediate regime ("Normal") with near-zero average returns and moderate volatility, the model captures the market better.

Both AIC and BIC strongly favor the 3-state model over the 2-state model, indicating that the additional state provides a better statistical fit to the data. Economically, the 3-state model provides a more realistic characterization of Japan's stock market behaviour by capturing the market that is stable but low growth that the 2-model cannot represent.

Therefore, the 3-state HMM is both statistically and economically better fit for the Japanese stock market data.

# References

Halton, N. (2025, October 9). Understanding Japan's Lost Decade: Key Factors and Lessons. Investopedia. <http://investopedia.com/terms/l/lost-decade.asp>

Kramer, L. (2024,June 19). Bull vs. Bear Markets: What's The Difference. Investopedia. <https://www.investopedia.com/insights/digging-deeper-bull-and-bear-markets/>

Shukla, P. (2025, July 23). Hidden Markov Model in R. GeeksforGeeks. <https://www.geeksforgeeks.org/machine-learning/hidden-markov-model-in-r/>

How to Calculate AIC in R?. (2025, July 23). GeeksforGeeks. <https://www.geeksforgeeks.org/r-language/how-to-calculate-aic-in-r/>

Zucchini, W., MacDonald, I.L., & Langrock, R. (2016). Hidden Markov Models for Time Series: An Introduction Using R, Second Edition (2nd ed.). Chapman and Hall/CRC. <https://doi.org/10.1201/b20790>
